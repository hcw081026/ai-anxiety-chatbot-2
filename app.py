import streamlit as st
import google.generativeai as genai
import os

# ==========================================
# 1. ì„¤ì • ë° ì´ˆê¸°í™”
# ==========================================
st.set_page_config(page_title="ë§ˆì¸ë“œí”½ìŠ¤ - AI ì‹¬ë¦¬ìƒë‹´", page_icon="ğŸŒ¿")

# ì œëª© ë° ì„¤ëª…
st.title("ğŸŒ¿ ì¸ì§€í–‰ë™ì¹˜ë£Œ(CBT) ìƒë‹´ ì±—ë´‡")
st.markdown("ë§ˆìŒì´ í˜ë“ ê°€ìš”? ë‹¹ì‹ ì˜ ì´ì•¼ê¸°ë¥¼ ë“£ê³  ê°ê´€ì ì¸ ì‹œê°ì„ ì°¾ì•„ë“œë¦½ë‹ˆë‹¤.")

# ì‚¬ì´ë“œë°”: API í‚¤ ì…ë ¥ (ë°°í¬ ì‹œ ë³´ì•ˆì„ ìœ„í•´)
with st.sidebar:
    st.header("ì„¤ì •")
    # Streamlit Secretsì—ì„œ ê°€ì ¸ì˜¤ê±°ë‚˜ ì‚¬ìš©ìì—ê²Œ ì§ì ‘ ì…ë ¥ë°›ìŒ
    if "GOOGLE_API_KEY" in st.secrets:
        api_key = st.secrets["GOOGLE_API_KEY"]
    else:
        api_key = st.text_input("Gemini API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”", type="password")
    
    st.info("ì´ ì±—ë´‡ì€ ì…ë ¥ëœ ëŒ€í™” ë°ì´í„°ë¥¼ í•™ìŠµ(In-context Learning)í•˜ì—¬ ìƒë‹´í•©ë‹ˆë‹¤.")

# ==========================================
# 2. í•™ìŠµ ë°ì´í„° (In-context Learning Data)
# ==========================================
# ì‚¬ìš©ìê°€ ì œê³µí•œ í…ìŠ¤íŠ¸ ë°ì´í„°ë¥¼ í•˜ë“œì½”ë”©í•˜ì—¬ íŒŒì¼ ì˜ì¡´ì„± ì œê±°
FEW_SHOT_EXAMPLES = [
    {
        "role": "user",
        "parts": ["ì‹œí—˜ì„ ë§ì³ì„œ ë‚´ ì¸ìƒì€ ëë‚œ ê²ƒ ê°™ì•„."]
    },
    {
        "role": "model",
        "parts": ["ì‹œí—˜ ê²°ê³¼ ë•Œë¬¸ì— ë§ì´ ë‚™ì‹¬í•˜ì…¨êµ°ìš”. í•˜ì§€ë§Œ ì´ë²ˆ ì‹œí—˜ í•˜ë‚˜ê°€ ì •ë§ ë‹¹ì‹ ì˜ ì¸ìƒ ì „ì²´ë¥¼ ê²°ì •ì§“ëŠ” ê²ƒì¼ê¹Œìš”? ì´ì „ì— ì˜ í•´ëƒˆë˜ ë‹¤ë¥¸ ì¼ë“¤ì€ ì—†ì—ˆë‚˜ìš”?"]
    },
    {
        "role": "user",
        "parts": ["ì‚¬ëŒë“¤ì´ ë‚˜ë¥¼ ì‹«ì–´í•˜ëŠ” ê²Œ ë¶„ëª…í•´."]
    },
    {
        "role": "model",
        "parts": ["ê·¸ë ‡ê²Œ ëŠë¼ê²Œ ëœ íŠ¹ë³„í•œ ê³„ê¸°ê°€ ìˆì—ˆë‚˜ìš”? í˜¹ì‹œ ìƒëŒ€ë°©ì˜ í–‰ë™ì„ ë„ˆë¬´ ë¶€ì •ì ìœ¼ë¡œ í•´ì„í•˜ê³  ìˆëŠ” ê±´ ì•„ë‹Œì§€ í•¨ê»˜ ìƒê°í•´ë³´ì•„ìš”."]
    },
    {
        "role": "user",
        "parts": ["ë°œí‘œí•  ë•Œ ì‹¤ìˆ˜í•˜ë©´ ë‚œ ì›ƒìŒê±°ë¦¬ê°€ ë  ê±°ì•¼."]
    },
    {
        "role": "model",
        "parts": ["ë°œí‘œ ì‹¤ìˆ˜ëŠ” ëˆ„êµ¬ë‚˜ í•  ìˆ˜ ìˆëŠ” ì¼ì´ì—ìš”. ë§Œì•½ ì¹œêµ¬ê°€ ì‹¤ìˆ˜í–ˆë‹¤ë©´ ë‹¹ì‹ ì€ ë¹„ì›ƒì—ˆì„ê¹Œìš”? ì•„ë§ˆ ê²©ë ¤í•´ì£¼ê³  ì‹¶ì—ˆì„ ê±°ì˜ˆìš”."]
    },
    {
        "role": "user",
        "parts": ["ì‹¬ì¥ì´ ë„ˆë¬´ ë¹¨ë¦¬ ë›°ê³  ì£½ì„ ê²ƒ ê°™ì•„."]
    },
    {
        "role": "model",
        "parts": ["ì§€ê¸ˆ ë§ì´ ë¬´ì„œìš°ì‹œì£ . ì´ê±´ ë¶ˆì•ˆ ë°œì‘ ì¦ìƒì¼ ìˆ˜ ìˆì–´ìš”. ì£½ì§€ ì•Šìœ¼ë‹ˆ ì•ˆì‹¬í•˜ì„¸ìš”. ì €ì™€ í•¨ê»˜ 4ì´ˆê°„ ìˆ¨ì„ ë“¤ì´ë§ˆì‹œê³  7ì´ˆê°„ ë©ˆì·„ë‹¤ê°€ ì²œì²œíˆ ë‚´ë±‰ì–´ ë³¼ê¹Œìš”?"]
    },
    {
        "role": "user",
        "parts": ["ë‚˜ëŠ” ì•„ë¬´ì§ì—ë„ ì“¸ëª¨ì—†ëŠ” ì‚¬ëŒì´ì•¼."]
    },
    {
        "role": "model",
        "parts": ["ì§€ê¸ˆ ìì‹ ì— ëŒ€í•´ ì•„ì£¼ ê°€í˜¹í•˜ê²Œ í‰ê°€í•˜ê³  ê³„ì‹œë„¤ìš”. ë‹¹ì‹ ì´ ì‚¬ë‘í•˜ëŠ” ê°€ì¡±ì´ë‚˜ ì¹œêµ¬ë“¤ì—ê²Œë„ ë„ì›€ì„ ì¤€ ì ì´ ìˆì§€ ì•Šë‚˜ìš”? ì‘ì€ ê²ƒì´ë¼ë„ ì¢‹ì•„ìš”."]
    }
]

# ==========================================
# 3. ëª¨ë¸ ë° ì„¸ì…˜ ë¡œì§
# ==========================================

# ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ (í˜ë¥´ì†Œë‚˜)
SYSTEM_INSTRUCTION = """
ë‹¹ì‹ ì€ ì¸ì§€í–‰ë™ì¹˜ë£Œ(CBT) ì „ë¬¸ê°€ 'ë§ˆì¸ë“œí”½ìŠ¤'ì…ë‹ˆë‹¤. 
ë‹¹ì‹ ì˜ ëª©í‘œëŠ” ë‚´ë‹´ìì˜ 'ë¶€ì •ì  ìë™ ì‚¬ê³ 'ë¥¼ ì°¾ì•„ë‚´ê³ , ì†Œí¬ë¼í…ŒìŠ¤ì‹ ì§ˆë¬¸ì„ í†µí•´ 'ëŒ€ì•ˆì  ì‚¬ê³ 'ë¥¼ í•˜ë„ë¡ ë•ëŠ” ê²ƒì…ë‹ˆë‹¤.
ìœ„ë¡œì™€ ê³µê°ì„ ë¨¼ì € í•˜ë˜, ë°˜ë“œì‹œ ë…¼ë¦¬ì ì¸ ì§ˆë¬¸ì„ ë˜ì ¸ ìŠ¤ìŠ¤ë¡œ ê¹¨ë‹«ê²Œ í•˜ì„¸ìš”.
í•™ìŠµëœ ì˜ˆì‹œ(Few-shot)ë“¤ì˜ ë§íˆ¬ì™€ êµ¬ì¡°ë¥¼ ìœ ì§€í•˜ì„¸ìš”.
"""

if api_key:
    # API ì„¤ì •
    genai.configure(api_key=api_key)
    
    # ëª¨ë¸ ì´ˆê¸°í™” (í•œ ë²ˆë§Œ ë¡œë“œ)
    if "chat_model" not in st.session_state:
        st.session_state.chat_model = genai.GenerativeModel(
            model_name="gemini-1.5-flash-latest",
            system_instruction=SYSTEM_INSTRUCTION
        )
        # ì¤‘ìš”: start_chatì— historyë¡œ ì˜ˆì œ ë°ì´í„°ë¥¼ ë„£ì–´ì¤Œ (ì¸ì»¨í…ìŠ¤íŠ¸ ëŸ¬ë‹ í•µì‹¬)
        st.session_state.chat_session = st.session_state.chat_model.start_chat(
            history=FEW_SHOT_EXAMPLES
        )

    # ì±„íŒ… ê¸°ë¡ ì´ˆê¸°í™” (í™”ë©´ í‘œì‹œìš©)
    if "messages" not in st.session_state:
        st.session_state.messages = []

    # ==========================================
    # 4. UI êµ¬í˜„ (ì±„íŒ… ì¸í„°í˜ì´ìŠ¤)
    # ==========================================

    # ì´ì „ ëŒ€í™” ë‚´ìš© í™”ë©´ì— í‘œì‹œ
    for message in st.session_state.messages:
        with st.chat_message(message["role"]):
            st.markdown(message["content"])

    # ì‚¬ìš©ì ì…ë ¥ ì²˜ë¦¬
    if prompt := st.chat_input("ê³ ë¯¼ì„ í„¸ì–´ë†“ìœ¼ì„¸ìš”..."):
        # 1) ì‚¬ìš©ì ë©”ì‹œì§€ í™”ë©´ í‘œì‹œ
        with st.chat_message("user"):
            st.markdown(prompt)
        st.session_state.messages.append({"role": "user", "content": prompt})

        # 2) AI ì‘ë‹µ ìƒì„±
        try:
            response = st.session_state.chat_session.send_message(prompt)
            bot_reply = response.text
            
            # 3) AI ë©”ì‹œì§€ í™”ë©´ í‘œì‹œ
            with st.chat_message("assistant"):
                st.markdown(bot_reply)
            st.session_state.messages.append({"role": "assistant", "content": bot_reply})
            
        except Exception as e:
            st.error(f"ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}")
else:

    st.warning("ì™¼ìª½ ì‚¬ì´ë“œë°”ì— Gemini API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.")

